<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GroupPlate Planner</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for better mobile look */
        .custom-scroll::-webkit-scrollbar {
            display: none;
        }
        .custom-scroll {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
        <svg class="animate-spin h-8 w-8 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-gray-400">Loading Planner...</p>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="hidden max-w-lg mx-auto pb-20">
        <header class="text-center mb-6">
            <h1 class="text-2xl font-bold text-yellow-500">GroupPlate Planner</h1>
            <p id="group-name-display" class="text-sm text-gray-400 mt-1"></p>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex mb-6 bg-gray-800 rounded-lg p-1 shadow-md">
            <button id="tab-planner" class="flex-1 py-2 text-sm font-medium rounded-md transition-colors bg-yellow-600 text-gray-900">üçΩÔ∏è Weekly Plan</button>
            <button id="tab-shopping" class="flex-1 py-2 text-sm font-medium rounded-md transition-colors text-gray-300 hover:text-yellow-500">üõí Shopping List</button>
        </div>

        <!-- Weekly Planner View -->
        <div id="view-planner">
            <div id="weekly-calendar" class="space-y-3 custom-scroll max-h-[70vh] overflow-y-auto">
                <!-- Days will be rendered here -->
            </div>
        </div>

        <!-- Shopping List View -->
        <div id="view-shopping" class="hidden">
            <div id="shopping-list-container" class="space-y-3 custom-scroll max-h-[70vh] overflow-y-auto">
                <!-- Shopping list items will be rendered here -->
            </div>
        </div>

        <!-- Context Display -->
        <p class="text-xs text-center text-gray-600 mt-4">User: <span id="user-display">N/A</span> | Group ID: <span id="chat-id-display">N/A</span></p>

    </div>

    <!-- Modal for Adding/Editing Meal -->
    <div id="add-meal-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold text-yellow-500 mb-4" id="modal-title">Plan Meal for Monday</h2>
            <input type="hidden" id="modal-day">

            <label for="meal-title" class="block text-sm font-medium text-gray-400 mb-1">Meal Title (e.g., Spaghetti Bolognese)</label>
            <input type="text" id="meal-title" placeholder="Required" class="w-full p-2 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-yellow-500 focus:border-yellow-500">

            <label for="recipe-url" class="block text-sm font-medium text-gray-400 mb-1">Recipe Link (Optional)</label>
            <input type="url" id="recipe-url" placeholder="https://myrecipe.com/pasta" class="w-full p-2 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-yellow-500 focus:border-yellow-500">

            <div class="flex justify-end space-x-3">
                <button onclick="hideModal('add-meal-modal')" class="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white rounded-lg transition-colors">Cancel</button>
                <button id="save-meal-btn" class="px-4 py-2 text-sm font-bold bg-yellow-600 text-gray-900 rounded-lg hover:bg-yellow-500 transition-colors">Save Meal</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal (Replaces showConfirm) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold text-yellow-500 mb-4" id="confirm-title">Confirm Action</h2>
            <p class="text-gray-300 mb-6" id="confirm-message">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white rounded-lg transition-colors">Cancel</button>
                <button id="confirm-ok-btn" class="px-4 py-2 text-sm font-bold bg-red-600 text-white rounded-lg hover:bg-red-500 transition-colors">Confirm</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, addDoc, updateDoc, deleteDoc, runTransaction, getDoc, getDocs, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Application State
        window.app;
        window.db;
        window.auth;
        window.currentUserId = 'unknown';
        window.currentUserName = 'Guest';
        window.chatId = null; // Key identifier for the group
        window.weeklyPlanData = {};
        window.shoppingListData = [];
        window.confirmCallback = null; // Stores callback for custom confirmation modal

        // --- Utility Functions ---

        // Function to create the base path for the specific group
        function getGroupDocRef() {
            if (!window.db || !window.chatId) {
                console.error("Firestore DB or Chat ID not initialized.");
                return null;
            }
            // Public path for collaborative data
            return doc(window.db, `/artifacts/${appId}/public/data/groups/${window.chatId}`);
        }

        // Function to get the shopping list collection reference
        function getShoppingListCollectionRef() {
            if (!window.db || !window.chatId) return null;
            return collection(getGroupDocRef(), 'shoppingList');
        }

        // Simulates ingredient parsing from a recipe link
        function simulateIngredientParsing(recipeTitle) {
            recipeTitle = recipeTitle.toLowerCase();
            if (recipeTitle.includes("spaghetti")) {
                return ["1 lb Spaghetti Pasta", "1 jar Tomato Sauce", "1 lb Ground Beef", "1 Onion", "Garlic cloves (4)"];
            } else if (recipeTitle.includes("salad")) {
                return ["Lettuce (1 head)", "Tomatoes (2)", "Cucumber (1)", "Dressing (1 bottle)"];
            } else {
                return ["Water", "Salt", "Basic Ingredient X"];
            }
        }
        
        // --- Custom Confirmation Modal Handlers ---

        function showCustomConfirm(title, message, onConfirm) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            window.confirmCallback = onConfirm;
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function initConfirmModalListeners() {
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                document.getElementById('confirmation-modal').classList.add('hidden');
            });

            document.getElementById('confirm-ok-btn').addEventListener('click', () => {
                document.getElementById('confirmation-modal').classList.add('hidden');
                if (window.confirmCallback) {
                    window.confirmCallback(true);
                }
            });
        }
        // --- End Custom Confirmation Modal Handlers ---


        // --- View Management ---

        function showView(viewId) {
            document.getElementById('view-planner').classList.add('hidden');
            document.getElementById('view-shopping').classList.add('hidden');
            document.getElementById('tab-planner').classList.remove('bg-yellow-600', 'text-gray-900');
            document.getElementById('tab-planner').classList.add('text-gray-300', 'hover:text-yellow-500');
            document.getElementById('tab-shopping').classList.remove('bg-yellow-600', 'text-gray-900');
            document.getElementById('tab-shopping').classList.add('text-gray-300', 'hover:text-yellow-500');

            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById(`tab-${viewId.replace('view-', '')}`).classList.add('bg-yellow-600', 'text-gray-900');
            document.getElementById(`tab-${viewId.replace('view-', '')}`).classList.remove('text-gray-300', 'hover:text-yellow-500');

            // Update MainButton text based on view
            if (window.Telegram.WebApp.MainButton.isVisible) {
                if (viewId === 'view-planner') {
                    window.Telegram.WebApp.MainButton.setText("View Shopping List");
                    window.Telegram.WebApp.MainButton.onClick(() => showView('view-shopping'));
                } else {
                    window.Telegram.WebApp.MainButton.setText("Back to Planner");
                    window.Telegram.WebApp.MainButton.onClick(() => showView('view-planner'));
                }
            }
        }

        function showModal(modalId, day = null, title = "Plan Meal") {
            const modal = document.getElementById(modalId);
            if (modalId === 'add-meal-modal') {
                document.getElementById('modal-day').value = day;
                document.getElementById('modal-title').textContent = `${title} for ${day}`;
                document.getElementById('meal-title').value = '';
                document.getElementById('recipe-url').value = '';
            }
            modal.classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- Firestore Listeners and Renderers ---

        function renderWeeklyPlan() {
            const calendarEl = document.getElementById('weekly-calendar');
            calendarEl.innerHTML = '';
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            days.forEach(day => {
                const meal = window.weeklyPlanData[day];
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-4 rounded-xl shadow-lg border-t-4 border-yellow-600 cursor-pointer transition-shadow hover:shadow-yellow-500/50';
                card.onclick = () => showModal('add-meal-modal', day);

                let content = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold text-yellow-500">${day}</h3>
                        ${meal ? `<button onclick="event.stopPropagation(); deleteMeal('${day}')" class="text-red-400 hover:text-red-500 text-sm">Remove</button>` : ''}
                    </div>
                `;

                if (meal) {
                    content += `
                        <p class="text-xl font-bold">${meal.title}</p>
                        ${meal.url ? `<a href="${meal.url}" target="_blank" class="text-sm text-yellow-400 hover:text-yellow-300 truncate block">${meal.url}</a>` : '<p class="text-sm text-gray-500">No recipe link provided.</p>'}
                    `;
                } else {
                    content += '<p class="text-gray-400 italic">Tap to plan meal...</p>';
                }

                card.innerHTML = content;
                calendarEl.appendChild(card);
            });
        }

        function renderShoppingList() {
            const listEl = document.getElementById('shopping-list-container');
            listEl.innerHTML = '';

            if (window.shoppingListData.length === 0) {
                 listEl.innerHTML = '<p class="text-center text-gray-500 italic p-8">The shopping list is currently empty. Add meals to the planner to generate ingredients!</p>';
                 return;
            }

            // Sort: Unpurchased, then Purchased
            const sortedList = [...window.shoppingListData].sort((a, b) => (a.isPurchased === b.isPurchased) ? 0 : a.isPurchased ? 1 : -1);

            sortedList.forEach(item => {
                const isChecked = item.isPurchased;
                const assigned = item.assignedToName || 'Unassigned';

                const listItem = document.createElement('div');
                listItem.className = `flex items-center justify-between p-3 rounded-lg shadow-md transition-all ${isChecked ? 'bg-gray-700 opacity-60' : 'bg-gray-800'}`;
                listItem.innerHTML = `
                    <div class="flex items-center flex-grow">
                        <input type="checkbox" id="item-${item.id}" ${isChecked ? 'checked' : ''} class="form-checkbox h-5 w-5 text-yellow-600 bg-gray-600 border-gray-500 rounded focus:ring-yellow-500"
                            onchange="togglePurchased('${item.id}', this.checked)">
                        <label for="item-${item.id}" class="ml-3 text-sm font-medium ${isChecked ? 'line-through text-gray-400' : 'text-white'}">
                            ${item.quantity ? `<span class="font-bold">${item.quantity}</span> of ${item.name}` : item.name}
                        </label>
                    </div>

                    <div class="flex items-center space-x-2 ml-4">
                        <button class="px-3 py-1 text-xs rounded-full transition-colors ${item.assignedTo === window.currentUserId ? 'bg-yellow-600 text-gray-900 font-semibold' : 'bg-gray-700 text-gray-300 hover:bg-yellow-700'}"
                            onclick="assignItem('${item.id}', '${item.assignedTo === window.currentUserId ? 'unassign' : 'assign'}')">
                            ${item.assignedTo === window.currentUserId ? 'Mine!' : assigned}
                        </button>
                    </div>
                `;
                listEl.appendChild(listItem);
            });
        }

        function initRealtimeListeners() {
            if (!window.chatId) {
                console.warn("Chat ID not set. Cannot initialize listeners.");
                return;
            }
            setLogLevel('debug');

            // Listener for Weekly Plan Document (Phase 3, Step 5)
            onSnapshot(getGroupDocRef(), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    window.weeklyPlanData = docSnapshot.data().weeklyPlan || {};
                    document.getElementById('group-name-display').textContent = docSnapshot.data().name || `Plan for Chat ID: ${window.chatId}`;
                } else {
                    console.log("Group plan doesn't exist, creating default.");
                    // Create default document if it doesn't exist
                    setDoc(getGroupDocRef(), {
                        name: 'Group Meal Plan',
                        weeklyPlan: {},
                        createdAt: new Date().toISOString()
                    }, { merge: true }).catch(e => console.error("Error creating default plan:", e));
                    window.weeklyPlanData = {};
                }
                renderWeeklyPlan();
            }, (error) => {
                console.error("Error listening to weekly plan:", error);
            });

            // Listener for Shopping List Collection (Phase 3, Step 7)
            onSnapshot(getShoppingListCollectionRef(), (snapshot) => {
                window.shoppingListData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderShoppingList();
            }, (error) => {
                 console.error("Error listening to shopping list:", error);
            });
        }

        // --- Data Manipulation Functions ---

        async function saveMeal() {
            const day = document.getElementById('modal-day').value;
            const title = document.getElementById('meal-title').value.trim();
            const url = document.getElementById('recipe-url').value.trim();

            if (!title) {
                // Changed from standard alert() to TWA native showAlert()
                window.Telegram.WebApp.showAlert('Please enter a meal title.'); 
                return;
            }

            hideModal('add-meal-modal');
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');

            try {
                // 1. Update the Weekly Plan Document
                const planUpdate = {
                    [`weeklyPlan.${day}`]: { title, url }
                };
                await updateDoc(getGroupDocRef(), planUpdate);
                console.log(`Meal added for ${day}.`);

                // 2. Automated Ingredient Consolidation (Phase 3, Step 6)
                await consolidateIngredients();

            } catch (e) {
                console.error("Error saving meal:", e);
                // Simple feedback for the user
                window.Telegram.WebApp.showAlert(`Error saving meal: ${e.message}`);
            }
        }

        async function deleteMeal(day) {
            // Use custom in-app confirmation modal to avoid the showPopup error
            showCustomConfirm(
                "Remove Meal",
                `Are you sure you want to remove the meal for ${day}? This will also remove its ingredients from the shopping list.`,
                async (isConfirmed) => {
                    if (isConfirmed) {
                        try {
                            const planRef = getGroupDocRef();
                            const docSnap = await getDoc(planRef);
                            if (docSnap.exists()) {
                                const currentPlan = docSnap.data().weeklyPlan;
                                delete currentPlan[day];

                                await setDoc(planRef, { weeklyPlan: currentPlan }, { merge: true });
                                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');

                                // Re-consolidate ingredients after deletion
                                await consolidateIngredients();
                            }
                        } catch (e) {
                            console.error("Error deleting meal:", e);
                            window.Telegram.WebApp.showAlert(`Error deleting meal: ${e.message}`);
                        }
                    }
                }
            );
        }

        async function consolidateIngredients() {
            // This function processes the current weeklyPlanData and updates the shoppingList collection.

            // 1. Clear the existing shopping list collection first (simplifying logic)
            const collectionRef = getShoppingListCollectionRef();
            const snapshot = await getDocs(collectionRef);
            const deletePromises = [];
            snapshot.docs.forEach(doc => {
                 deletePromises.push(deleteDoc(doc.ref));
            });
            await Promise.all(deletePromises);


            // 2. Generate new list from all planned meals
            const newIngredientMap = {};
            for (const day in window.weeklyPlanData) {
                const meal = window.weeklyPlanData[day];
                // Simulate ingredient extraction
                const ingredients = simulateIngredientParsing(meal.title);

                ingredients.forEach(item => {
                    // Simple consolidation: group by ingredient name (ignoring quantity parsing for simplicity)
                    const name = item.split('(')[0].trim(); // Simple way to clean up e.g., "Garlic cloves (4)" -> "Garlic cloves"
                    const quantity = item.includes('(') ? item.substring(item.indexOf('(') + 1, item.lastIndexOf(')')) : null;
                    const key = name.toLowerCase();

                    if (newIngredientMap[key]) {
                        // If it exists, append the name and quantity (not mathematically combining, just adding)
                        newIngredientMap[key].quantity += `, ${quantity || name}`;
                    } else {
                        newIngredientMap[key] = {
                            name: name,
                            quantity: quantity,
                            isPurchased: false,
                            assignedTo: null,
                            assignedToName: null,
                        };
                    }
                });
            }

            // 3. Add new ingredients to the shopping list collection
            const addPromises = [];
            for (const key in newIngredientMap) {
                addPromises.push(addDoc(collectionRef, newIngredientMap[key]));
            }
            await Promise.all(addPromises);
            console.log("Shopping list consolidated and updated.");
        }

        async function togglePurchased(itemId, isChecked) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            try {
                const itemRef = doc(getShoppingListCollectionRef(), itemId);
                await updateDoc(itemRef, { isPurchased: isChecked });
            } catch (e) {
                console.error("Error toggling purchased status:", e);
                window.Telegram.WebApp.showAlert("Could not update item status.");
            }
        }

        async function assignItem(itemId, action) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            try {
                const itemRef = doc(getShoppingListCollectionRef(), itemId);
                let updateData = {};

                if (action === 'assign') {
                    updateData = {
                        assignedTo: window.currentUserId,
                        assignedToName: window.currentUserName
                    };
                } else if (action === 'unassign') {
                    updateData = {
                        assignedTo: null,
                        assignedToName: null
                    };
                }

                await updateDoc(itemRef, updateData);
            } catch (e) {
                console.error("Error assigning item:", e);
                window.Telegram.WebApp.showAlert("Could not assign item.");
            }
        }

        // --- Initialization ---

        function getTelegramContext() {
            // Get user and chat ID from the Telegram Web App context
            if (typeof window.Telegram.WebApp === 'undefined' || !window.Telegram.WebApp.initDataUnsafe) {
                console.warn("Telegram Web App context not available. Using mock data.");
                window.chatId = 'MOCK_GROUP_12345';
                window.currentUserId = 'MOCK_USER_999';
                window.currentUserName = 'Mock User';
            } else {
                window.Telegram.WebApp.ready();
                const initData = window.Telegram.WebApp.initDataUnsafe;
                // Use a combination of chat_id and chat_type for a unique public key
                const chatIdRaw = initData.chat?.id || initData.receiver?.id || 'default_chat';
                const chatType = initData.chat?.type || 'private';

                // Use the combination as the unique group/collaboration key
                window.chatId = `${chatIdRaw}_${chatType}`;

                if (initData.user) {
                    window.currentUserId = initData.user.id.toString();
                    window.currentUserName = initData.user.first_name + (initData.user.last_name ? ' ' + initData.user.last_name : '');
                } else {
                     window.currentUserId = 'anon_' + (auth.currentUser?.uid || 'noauth');
                     window.currentUserName = 'Anonymous User';
                }
            }

            document.getElementById('user-display').textContent = window.currentUserName;
            document.getElementById('chat-id-display').textContent = window.chatId;

            // Set up main button
            window.Telegram.WebApp.MainButton.setText("View Shopping List");
            window.Telegram.WebApp.MainButton.show();
            window.Telegram.WebApp.MainButton.onClick(() => showView('view-shopping'));
        }

        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                return;
            }

            try {
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                // Authentication (Phase 1, Step 2)
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        console.log("User authenticated:", user.uid);
                        // Get Telegram context and start listeners
                        getTelegramContext();
                        initRealtimeListeners();
                        document.getElementById('loading').classList.add('opacity-0', 'pointer-events-none');
                        document.getElementById('app-container').classList.remove('hidden');
                    } else {
                        console.log("No user signed in.");
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500">Error loading app: ${error.message}</p>`;
            }
        }

        // Global functions for inline HTML calls
        window.saveMeal = saveMeal;
        window.hideModal = hideModal;
        window.showModal = showModal;
        window.showView = showView;
        window.togglePurchased = togglePurchased;
        window.assignItem = assignItem;
        window.deleteMeal = deleteMeal;
        // Exporting confirmation function for use in deleteMeal
        window.showCustomConfirm = showCustomConfirm;

        // Start the application
        window.onload = initFirebase;

        // Attach event listeners for tabs and custom confirmation modal
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tab-planner').addEventListener('click', () => showView('view-planner'));
            document.getElementById('tab-shopping').addEventListener('click', () => showView('view-shopping'));
            document.getElementById('save-meal-btn').addEventListener('click', saveMeal);
            initConfirmModalListeners(); // Initialize listeners for the new confirmation modal
        });

    </script>
    <!-- Include Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
